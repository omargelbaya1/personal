create table order_count_by_status
AS
select order_status, count(*) as order_count
from orders
group by 1;

select * from order_count_by_status;

create table orders_stg
as
select * from orders where false;

select * from orders_stg;


CREATE TABLE daily_revenue
as
select o.order_date,
	round(sum(oi.order_item_subtotal)::numeric,2) as order_revenue
from orders as o
	join order_items as oi
		on o.order_id = oi.order_item_order_id
where o.order_status in ('COMPLETE','CLOSED')
GROUP BY 1 ;

select * from daily_revenue
order by order_date;

create table daily_product_revenue
as
select o.order_date,
	oi.order_item_product_id,
	round(sum(oi.order_item_subtotal)::numeric, 2) as order_revenue
from orders as o
	join order_items as oi
		on o.order_id = oi.order_item_order_id
where o.order_status in ('COMPLETE','CLOSED')
group by 1,2;


select * from daily_product_revenue
order by 1 ,3 desc;


select * from daily_revenue
order by 1;


SELECT to_char(dr.order_date::timestamp, 'yyyy-MM') AS order_month,
    dr.order_date,
    dr.order_revenue,
    sum(order_revenue) OVER (
        PARTITION BY to_char(dr.order_date::timestamp, 'yyyy-MM')
    ) AS monthly_order_revenue
FROM daily_revenue AS dr
ORDER BY 2;


SELECT dr.*,
    sum(order_revenue) OVER (PARTITION BY 1) AS total_order_revenue
FROM daily_revenue AS dr
ORDER BY 1;


select count(*) from daily_product_revenue;

select * from daily_product_revenue
order by order_date, order_revenue desc;


--rank : typically followed by over() where we specify partition by or order by

--dense_rank() : typically followed by over() where we specify partition by or order by

--global ranking --> just order by when using a rank function
-- ranking based on key or partition key --> using both partiton and order by

select * from(
select order_date,
	order_item_product_id,
	order_revenue,
	rank() over (order by order_revenue desc) as rnk
from daily_product_revenue
where order_date='2014-01-01 00:00:00.0'
order by order_revenue desc)
where rnk<=5;


-- Using Common Table Expressions or CTEs
WITH daily_product_revenue_ranks AS (
    SELECT order_date,
        order_item_product_id,
        order_revenue,
        rank() OVER (ORDER BY order_revenue DESC) AS rnk,
        dense_rank() OVER (ORDER BY order_revenue DESC) AS drnk
    FROM daily_product_revenue
    WHERE order_date = '2014-01-01 00:00:00.0'
) SELECT * FROM daily_product_revenue_ranks
WHERE drnk <= 5
ORDER BY order_revenue DESC;


create table student_scores(
student_id int primary key,
student_score int
);

select * from student_scores;

INSERT INTO student_scores VALUES
(1, 980),
(2, 960),
(3, 960),
(4, 990),
(5, 920),
(6, 960),
(7, 980),
(8, 960),
(9, 940),
(10, 940);


 
SELECT student_id,
    student_score,
    rank() OVER (ORDER BY student_score DESC) AS student_rank,
    dense_rank() OVER (ORDER BY student_score DESC) AS student_drank
FROM student_scores
ORDER BY student_score DESC;
